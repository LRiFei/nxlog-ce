<?xml version="1.0" encoding="UTF-8"?>
<section id="om_dbi">
  <title>DBI (om_dbi)</title>
  <para>
    The om_dbi module utilizes the <ulink url="http://libdbi.sourceforge.net">libdbi</ulink>
    database abstraction library to enable storing logs in various database engines supported
    by the library such as MySQL, PostgreSQL, MSSQL, Sybase, Oracle, SQLite, Firebird.
    This module makes it possible to insert logs directly into an SQL database. You can specify
    the INSERT statement which will be executed for each log, this enables inserts into
    any table schema.
  </para>
  <note>
    <para>
      The im_dbi and om_dbi modules support GNU/Linux only because of the libdbi library.
      The im_odbc and om_odbc modules provide native database access on Windows (available only in 
      the NXLog Enterprise Edition).
    </para>
  </note>
  <note>
    <para>
      libdbi needs <link linkend="om_dbi_config_driver">drivers</link> to be able to access
      the database engines. These are in the libdbd-* packages on Debian and Ubuntu Linux.
      On Centos 5.6 there is a libdbi-drivers rpm package but this does seem to contain any 
      driver binaries under /usr/lib64/dbd. The real driver for MySQL lives in libdbi-dbd-mysql.
      Same for PostgreSQL. Make sure you have these installed, otherwise you will get a libdbi
      driver initialization error.
    </para>
  </note>

  <section id="om_dbi_config">
    <title>Configuration</title>
    <para>
      In addition to the <link linkend="config_module_common">common module directives</link>,
      the following can be used to configure the om_dbi module instance.
      <variablelist>
	<varlistentry>
	  <term><anchor id="om_dbi_config_driver"/>Driver</term>
	  <listitem>
	    <simpara>
	      This mandatory directive specifies the name of the libdbi driver which will be used
	      to connect to the database. 
	      You will need to provide a DRIVER name here for which a loadable driver module 
	      exists under the name libdbdDRIVER.so (usually under /usr/lib/dbd/).
	      The mysql driver is in the libdbdmysql.so file.
	    </simpara>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><anchor id="om_dbi_config_sql"/>SQL</term>
	  <listitem>
	    <simpara>
	      This directive should specify the INSERT statement which is executed for each log
	      message. The fields names (names with a $ sign) will be replaced with the value
	      they contain. String types will be quoted.
	    </simpara>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><anchor id="om_dbi_config_option"/>Option</term>
	  <listitem>
	    <simpara>
	      This directive can be used to specify additional driver options such as
	      the connection parameters. The manual of the libdbi driver should contain
	      the available options which can be used here.
	    </simpara>
	  </listitem>
	</varlistentry>

      </variablelist>
    </para>
  </section>

  <section id="om_dbi_config_examples">
    <title>Configuration examples</title>
    <para>
      These two examples below are for the plain syslog fields. Depending on your requirements,
      you may want to store additional or other fields which were generated by parsers, regexp rules,
      the <link linkend="pm_pattern">pm_pattern</link> pattern matcher module or input modules.
      Notably the <link linkend="im_msvistalog">im_msvistalog</link> and 
      <link linkend="im_mseventlog">im_mseventlog</link> modules generate different fields 
      which you may want to store in an SQL database similarly to these examples.
      <example>
	<title>Storing syslog in a PostgreSQL database</title>
	<para>
	  Below is a table schema which can be used to store syslog data.
<programlisting><![CDATA[
CREATE TABLE log (
	id serial,
        timestamp timestamp  not null,
	hostname varchar(32) default NULL,
	facility varchar(10) default NULL,
	severity varchar(10) default NULL,
	application varchar(10) default NULL,
	message text,
	PRIMARY KEY (id)
);]]></programlisting>
	And the config file:
	</para>
	<xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="../../../config-examples/config-example-om_dbi_pgsql.xml" />
      </example>
    </para>
    <para>
      <example>
	<title>Storing logs in a MySQL database</title>
	<xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="../../../config-examples/config-example-om_dbi_mysql.xml" />
      </example>
    </para>
  </section>
</section>
